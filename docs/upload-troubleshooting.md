# 文件上传问题诊断指南

## 常见问题及解决方案

### 1. 文件格式不支持
**问题描述**: 上传某些格式的图片时报错

**解决方案**:
- 已支持格式: jpg, jpeg, png, gif, webp, bmp
- 如果文件没有扩展名，会自动使用jpg格式
- 检查文件是否为有效的图片格式

### 2. 文件大小超限
**问题描述**: 文件太大导致上传失败

**解决方案**:
- 文件大小限制: 10MB
- 建议压缩图片后再上传
- 使用压缩后的图片格式

### 3. 网络问题
**问题描述**: 网络不稳定导致上传失败

**解决方案**:
- 检查网络连接
- 重试上传操作
- 查看控制台错误日志

### 4. 云存储配置问题
**问题描述**: 云存储环境配置错误

**解决方案**:
- 检查 `utils/config.js` 中的环境ID
- 确认云存储服务已开通
- 验证环境ID是否正确

### 5. wx.chooseMedia API 兼容性问题
**问题描述**: `chooseMedia:fail w.lookup(...).indexOf is not a function`

**解决方案**:
- 这是微信开发者工具的已知问题
- 已添加 `wx.chooseImage` 作为备选方案
- 系统会自动降级使用兼容的API
- 不影响功能使用，只是API调用方式不同

### 6. HTTP 协议图片链接问题
**问题描述**: `图片链接 http://tmp/... 不再支持 HTTP 协议，请升级到 HTTPS`

**解决方案**:
- 微信小程序要求图片链接必须使用 HTTPS 协议
- 已优化图片显示逻辑，上传完成后立即使用云存储URL
- 临时文件路径会自动替换为云存储的HTTPS链接
- 上传过程中显示本地预览，上传完成后显示云存储链接

## 调试步骤

### 1. 查看控制台日志
在微信开发者工具的控制台中查看详细的上传日志：
```
开始上传文件: { filePath: "...", cloudPath: "..." }
文件上传成功: { fileID: "...", statusCode: 200 }
```

### 2. 检查文件信息
上传前会显示文件的基本信息：
- 文件路径
- 文件大小
- 文件扩展名

### 3. 错误信息分析
如果上传失败，会显示详细的错误信息：
- 错误类型
- 错误描述
- 相关参数

## 测试建议

### 1. 测试不同格式
尝试上传以下格式的图片：
- JPG/JPEG
- PNG
- GIF
- WebP
- BMP

### 2. 测试不同大小
- 小文件 (< 1MB)
- 中等文件 (1-5MB)
- 大文件 (5-10MB)
- 超大文件 (> 10MB，应该被拒绝)

### 3. 测试不同来源
- 相册选择
- 相机拍摄
- 聊天文件

## 配置检查

### 1. 环境配置
确保 `utils/config.js` 配置正确：
```javascript
module.exports = {
  CLOUD_ENV_ID: 'your-env-id',
  CLOUD_SERVICE_NAME: 'your-service-name'
};
```

### 2. 云存储权限
确保小程序已开通云存储功能，并且有上传权限。

### 3. 文件路径格式
云存储路径格式：
- 帖子图片: `posts/YYYYMMDD/timestamp_index.ext`
- 相机图片: `camera/YYYYMMDD/timestamp.ext`

## 兼容性说明

### API 降级策略
为了确保在不同环境下都能正常工作，系统采用了以下降级策略：

1. **优先使用 `wx.chooseMedia`** - 新版本API，功能更丰富
2. **自动降级到 `wx.chooseImage`** - 如果新API失败，自动使用旧版本API
3. **无缝切换** - 用户无感知，功能完全一致

### 支持的微信版本
- 微信开发者工具: 1.06.2307260 及以上
- 微信客户端: 7.0.0 及以上
- 小程序基础库: 2.10.0 及以上

## 联系支持

如果问题仍然存在，请提供以下信息：
1. 错误截图
2. 控制台日志
3. 文件格式和大小
4. 微信开发者工具版本
5. 小程序版本
6. 微信客户端版本 