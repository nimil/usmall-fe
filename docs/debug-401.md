# 401错误调试指南

## 问题描述
当API返回401错误时，页面显示"网络错误请重试"而不是跳转到用户注册页面。

## 最新修复
修复了 `wx.getApp is not a function` 错误，添加了安全的全局状态管理。

## 当前状态
根据您提供的错误信息：
```json
{
  "statusCode": 401,
  "data": "User not found, please register first\n"
}
```

API确实返回了401错误，但是我们的错误处理逻辑没有被正确执行。

## 调试步骤

### 1. 检查控制台日志
在微信开发者工具的控制台中查看以下日志：
- `API响应状态码: 401`
- `检测到401错误，需要用户注册`
- `全局状态已更新` 或 `全局应用实例不可用`
- `执行页面跳转`
- `页面跳转成功` 或 `页面跳转失败`
- `在catch块中检测到401错误`
- `在catch块中执行页面跳转`

### 2. 检查全局状态
在控制台中执行以下代码检查全局状态：
```javascript
const app = wx.getApp();
console.log('全局状态:', app.globalData);
```

### 3. 手动测试页面跳转
在控制台中手动测试跳转：
```javascript
wx.navigateTo({
  url: '/pages/user-register/user-register?from=401',
  success: () => {
    console.log('手动跳转成功');
  },
  fail: (error) => {
    console.error('手动跳转失败:', error);
  }
});
```

### 4. 使用测试按钮
如果用户已登录，页面会显示"测试401"按钮，点击可以测试401错误处理。

### 5. 检查页面注册
确认用户注册页面是否在 `app.json` 中正确注册：
```json
{
  "pages": [
    "pages/user-register/user-register"
  ]
}
```

## 可能的问题

### 1. 错误处理逻辑冲突
- 可能有多个地方处理401错误
- 错误可能被其他错误处理逻辑覆盖

### 2. 页面跳转被阻止
- 当前页面栈可能已满（最多10个页面）
- 可能有其他代码阻止了页面跳转

### 3. 异步执行问题
- 页面跳转可能在错误的时机执行
- 可能有其他异步操作干扰

### 4. 微信云托管错误处理
- 微信云托管可能有自己的错误处理机制
- 我们的错误处理可能被覆盖

### 5. 全局应用实例问题（已修复）
- `wx.getApp()` 在某些情况下可能不可用
- 已添加安全检查和处理

## 修复方案

### 1. 双重错误处理
在 `ApiService.call()` 方法中添加了双重错误处理：
- 在正常流程中检查401错误
- 在catch块中也检查401错误

### 2. 安全全局状态管理
- 添加了 `updateGlobalData()` 和 `getGlobalData()` 方法
- 添加了安全检查，避免 `wx.getApp is not a function` 错误

### 3. 详细日志
添加了详细的调试日志来跟踪执行流程。

### 4. 延迟跳转
使用 `setTimeout` 确保跳转在正确的时机执行。

### 5. 错误传播
确保401错误能够正确传播到调用方。

## 测试方法

### 1. 查看控制台日志
打开微信开发者工具的控制台，查看所有相关的日志信息。

### 2. 使用测试按钮
点击页面上的"测试401"按钮来测试错误处理。

### 3. 手动触发
在控制台中手动调用API方法来测试。

### 4. 真机测试
在真机上测试完整的错误处理流程。

## 预期行为

1. API返回401错误
2. 控制台显示相关日志
3. 自动跳转到用户注册页面
4. 全局状态被正确设置
5. 用户完成注册后自动返回原页面

## 如果仍然不工作

如果问题仍然存在，请：

1. 提供控制台的完整日志信息
2. 检查是否有其他错误信息
3. 确认微信开发者工具的版本
4. 尝试在真机上测试
5. 检查网络连接状态
6. 确认小程序是否完全初始化
