# 401错误处理功能测试指南

## 测试环境准备

### 1. 开发环境
- 微信开发者工具
- 小程序项目已正确配置
- 微信云托管服务已部署

### 2. 测试账号
- 准备一个未注册的微信账号用于测试
- 准备一个已注册的微信账号用于对比测试

## 测试场景

### 场景1：未注册用户访问我的帖子

#### 测试步骤
1. 清除本地存储的用户信息
2. 使用未注册的微信账号登录小程序
3. 进入"我的"页面
4. 点击"我的帖子"菜单项
5. 观察是否自动跳转到用户注册页面

#### 预期结果
- 显示"请先完善用户信息"的提示
- 自动跳转到用户注册页面
- 页面标题显示"完善用户信息"

### 场景2：用户注册流程

#### 测试步骤
1. 在用户注册页面点击头像选择按钮
2. 选择一张头像图片
3. 在昵称输入框中输入昵称
4. 在个人简介中输入简介（可选）
5. 点击"完成注册"按钮

#### 预期结果
- 头像选择功能正常
- 昵称输入框上方显示微信昵称提示
- 表单验证正常工作（头像和昵称为必填）
- 注册成功后显示"注册成功"提示
- 自动返回上一页并重新加载数据

### 场景3：注册后自动重试API

#### 测试步骤
1. 在未注册状态下访问我的帖子页面
2. 完成用户注册
3. 观察是否自动返回我的帖子页面
4. 检查帖子列表是否正常显示

#### 预期结果
- 注册成功后自动返回我的帖子页面
- 帖子列表正常加载和显示
- 用户信息正确保存到本地存储

### 场景4：安全检测功能

#### 测试步骤
1. 尝试上传可能违规的头像图片
2. 输入可能违规的昵称内容
3. 观察微信的安全检测机制

#### 预期结果
- 违规内容会被微信拦截
- 头像选择事件不会触发（如果图片违规）
- 昵称输入内容会被清空（如果内容违规）

### 场景5：网络错误处理

#### 测试步骤
1. 断开网络连接
2. 尝试访问需要认证的页面
3. 恢复网络连接
4. 重新尝试操作

#### 预期结果
- 网络错误时显示相应提示
- 网络恢复后可以正常操作

## 测试检查清单

### 功能检查
- [ ] 401错误正确检测
- [ ] 自动跳转到用户注册页面
- [ ] 头像选择功能正常
- [ ] 昵称输入功能正常
- [ ] 个人简介输入功能正常
- [ ] 表单验证正确
- [ ] 用户注册API调用成功
- [ ] 注册成功后自动重试原始API
- [ ] 用户信息正确保存
- [ ] 返回上一页功能正常

### UI检查
- [ ] 用户注册页面布局美观
- [ ] 头像选择按钮样式正确
- [ ] 输入框样式和交互正常
- [ ] 按钮状态变化正确
- [ ] 加载状态显示正确
- [ ] 错误提示信息清晰

### 安全检查
- [ ] 微信头像安全检测正常工作
- [ ] 微信昵称安全检测正常工作
- [ ] 违规内容被正确拦截
- [ ] 用户输入内容符合规范

### 性能检查
- [ ] 页面跳转流畅
- [ ] 头像上传速度正常
- [ ] API调用响应及时
- [ ] 内存使用合理

## 常见问题排查

### 1. 401错误未正确检测
- 检查 `utils/api.js` 中的错误检测逻辑
- 确认 `result.statusCode` 的值
- 检查错误抛出机制

### 2. 页面跳转失败
- 检查 `app.json` 中是否正确注册了用户注册页面
- 确认页面路径是否正确
- 检查页面文件是否完整

### 3. 头像选择不工作
- 确认微信基础库版本是否支持 `chooseAvatar`
- 检查 `button` 组件的 `open-type` 属性
- 确认真机环境（开发者工具可能不完全支持）

### 4. 昵称输入异常
- 确认微信基础库版本是否支持 `type="nickname"`
- 检查输入框的配置
- 确认真机环境

### 5. 注册API调用失败
- 检查网络连接
- 确认API地址和参数正确
- 检查云托管服务状态

### 6. 重试机制不工作
- 检查全局状态管理
- 确认 `lastApiCall` 是否正确保存
- 检查重试逻辑

## 调试技巧

### 1. 使用控制台日志
```javascript
console.log('401错误检测:', result.statusCode);
console.log('全局状态:', wx.getApp().globalData);
console.log('API调用参数:', options);
```

### 2. 使用微信开发者工具
- 使用 Network 面板查看API请求
- 使用 Storage 面板查看本地存储
- 使用 Console 面板查看日志

### 3. 真机调试
- 在真机上测试头像选择功能
- 测试微信昵称输入功能
- 测试安全检测机制

### 4. 模拟401错误
可以通过修改后端服务来模拟401错误，或者临时修改API调用逻辑来测试错误处理流程。

## 测试数据

### 测试用户信息
```javascript
// 正常用户信息
{
  nickname: "测试用户",
  avatar: "头像URL",
  bio: "这是一个测试账号"
}

// 边界情况
{
  nickname: "", // 空昵称
  avatar: "", // 空头像
  bio: "很长的个人简介..." // 超长简介
}
```

### 测试API响应
```javascript
// 401错误响应
{
  statusCode: 401,
  data: "User not found, please register first\n"
}

// 注册成功响应
{
  code: 0,
  msg: "User registered successfully",
  data: { /* 用户信息 */ }
}
```

## 注意事项

1. **真机测试**：头像选择和昵称输入功能需要在真机上测试
2. **微信版本**：确保微信版本支持相关功能
3. **网络环境**：测试不同网络环境下的表现
4. **用户体验**：确保整个流程对用户友好
5. **错误处理**：测试各种异常情况的处理
